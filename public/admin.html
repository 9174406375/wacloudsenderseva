<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - WhatsApp Bulk Sender</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <!-- Notification Toast Container -->
    <div id="toast-container"></div>

    <div class="admin-container">
        <header class="admin-header">
            <div class="admin-logo">
                <i class="fas fa-user-shield"></i>
                <h1>Admin Control Panel</h1>
            </div>
            <div class="admin-actions">
                <a href="/dashboard" class="btn btn-outline">
                    <i class="fas fa-arrow-left"></i> Back to Dashboard
                </a>
                <button class="btn btn-danger" id="adminLogoutBtn">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </header>

        <div class="admin-content">
            <!-- System Overview Cards -->
            <div class="admin-stats-grid">
                <div class="admin-stat-card primary">
                    <div class="stat-icon">
                        <i class="fas fa-paper-plane"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="adminTotalMessages">0</h3>
                        <p>Total Messages</p>
                    </div>
                </div>
                <div class="admin-stat-card success">
                    <div class="stat-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="adminSuccessRate">0%</h3>
                        <p>Success Rate</p>
                    </div>
                </div>
                <div class="admin-stat-card warning">
                    <div class="stat-icon">
                        <i class="fas fa-rocket"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="adminActiveCampaigns">0</h3>
                        <p>Active Campaigns</p>
                    </div>
                </div>
                <div class="admin-stat-card info">
                    <div class="stat-icon">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="adminDailyLimit">0 / 1000</h3>
                        <p>Today's Quota</p>
                    </div>
                </div>
            </div>

            <!-- WhatsApp Connection Control -->
            <div class="admin-card">
                <div class="admin-card-header">
                    <h3><i class="fab fa-whatsapp"></i> WhatsApp Connection Status</h3>
                </div>
                <div class="admin-card-body">
                    <div class="connection-info">
                        <div class="info-row">
                            <span class="label">Status:</span>
                            <span class="value" id="adminConnectionStatus">
                                <span class="status-dot connected"></span> Connected
                            </span>
                        </div>
                        <div class="info-row">
                            <span class="label">Connected Number:</span>
                            <span class="value" id="adminConnectedNumber">+91 XXXX XXXX</span>
                        </div>
                        <div class="info-row">
                            <span class="label">Name:</span>
                            <span class="value" id="adminConnectedName">Loading...</span>
                        </div>
                        <div class="info-row">
                            <span class="label">Platform:</span>
                            <span class="value" id="adminPlatform">Web</span>
                        </div>
                    </div>
                    <div class="admin-actions-group">
                        <button class="btn btn-danger" id="forceLogoutBtn">
                            <i class="fas fa-power-off"></i> Force Logout
                        </button>
                        <button class="btn btn-warning" id="reconnectBtn">
                            <i class="fas fa-sync"></i> Reconnect
                        </button>
                    </div>
                </div>
            </div>

            <!-- System Logs -->
            <div class="admin-card">
                <div class="admin-card-header">
                    <h3><i class="fas fa-list"></i> System Logs</h3>
                    <button class="btn btn-sm btn-outline" id="refreshLogsBtn">
                        <i class="fas fa-sync"></i> Refresh
                    </button>
                </div>
                <div class="admin-card-body">
                    <div class="logs-container" id="systemLogs">
                        <p class="empty-state">Loading logs...</p>
                    </div>
                </div>
            </div>

            <!-- All Campaigns Management -->
            <div class="admin-card">
                <div class="admin-card-header">
                    <h3><i class="fas fa-tasks"></i> All Campaigns</h3>
                    <div class="filter-tabs">
                        <button class="filter-tab active" data-status="all">All</button>
                        <button class="filter-tab" data-status="running">Running</button>
                        <button class="filter-tab" data-status="completed">Completed</button>
                        <button class="filter-tab" data-status="failed">Failed</button>
                    </div>
                </div>
                <div class="admin-card-body">
                    <div class="table-responsive">
                        <table class="admin-table" id="campaignsTable">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th>Status</th>
                                    <th>Recipients</th>
                                    <th>Sent</th>
                                    <th>Failed</th>
                                    <th>Progress</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="campaignsTableBody">
                                <tr>
                                    <td colspan="9" class="text-center">Loading campaigns...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Message Logs -->
            <div class="admin-card">
                <div class="admin-card-header">
                    <h3><i class="fas fa-envelope"></i> Recent Messages</h3>
                </div>
                <div class="admin-card-body">
                    <div class="table-responsive">
                        <table class="admin-table" id="messagesTable">
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>Phone Number</th>
                                    <th>Message</th>
                                    <th>Status</th>
                                    <th>Direction</th>
                                </tr>
                            </thead>
                            <tbody id="messagesTableBody">
                                <tr>
                                    <td colspan="5" class="text-center">Loading messages...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="/js/app.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            initializeAdmin();
        });

        async function initializeAdmin() {
            await loadDashboardStats();
            await loadSystemLogs();
            await loadAllCampaigns();
            await loadRecentMessages();
            await updateWhatsAppStatus();

            // Event listeners
            document.getElementById('forceLogoutBtn').addEventListener('click', forceLogout);
            document.getElementById('refreshLogsBtn').addEventListener('click', loadSystemLogs);
            
            // Filter tabs
            document.querySelectorAll('.filter-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    filterCampaigns(tab.dataset.status);
                });
            });

            // Auto-refresh every 10 seconds
            setInterval(() => {
                loadDashboardStats();
                updateWhatsAppStatus();
            }, 10000);
        }

        async function loadDashboardStats() {
            try {
                const response = await fetch('/api/admin/dashboard');
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('adminTotalMessages').textContent = data.data.totalMessages;
                    document.getElementById('adminSuccessRate').textContent = data.data.successRate + '%';
                    document.getElementById('adminActiveCampaigns').textContent = data.data.activeCampaigns;
                    document.getElementById('adminDailyLimit').textContent = 
                        `${data.data.dailyStats.messagesSentToday} / ${data.data.dailyStats.dailyLimit}`;
                }
            } catch (error) {
                console.error('Failed to load dashboard stats:', error);
            }
        }

        async function updateWhatsAppStatus() {
            try {
                const response = await fetch('/api/whatsapp/status');
                const data = await response.json();
                
                if (data.success && data.data.isReady) {
                    document.getElementById('adminConnectedNumber').textContent = 
                        `+${data.data.clientInfo.number}`;
                    document.getElementById('adminConnectedName').textContent = 
                        data.data.clientInfo.name;
                    document.getElementById('adminPlatform').textContent = 
                        data.data.clientInfo.platform || 'Web';
                }
            } catch (error) {
                console.error('Failed to update WhatsApp status:', error);
            }
        }

        async function loadSystemLogs() {
            try {
                const response = await fetch('/api/stats/system-logs?limit=20');
                const data = await response.json();
                
                if (data.success) {
                    const logsContainer = document.getElementById('systemLogs');
                    logsContainer.innerHTML = '';
                    
                    data.data.forEach(log => {
                        const logItem = document.createElement('div');
                        logItem.className = 'log-item';
                        logItem.innerHTML = `
                            <span class="log-time">${new Date(log.created_at).toLocaleString()}</span>
                            <span class="log-type ${log.event_type}">${log.event_type}</span>
                            <span class="log-data">${JSON.stringify(JSON.parse(log.event_data), null, 2)}</span>
                        `;
                        logsContainer.appendChild(logItem);
                    });
                }
            } catch (error) {
                console.error('Failed to load logs:', error);
            }
        }

        async function loadAllCampaigns() {
            try {
                const response = await fetch('/api/campaigns');
                const data = await response.json();
                
                if (data.success) {
                    renderCampaignsTable(data.data);
                }
            } catch (error) {
                console.error('Failed to load campaigns:', error);
            }
        }

        function renderCampaignsTable(campaigns) {
            const tbody = document.getElementById('campaignsTableBody');
            tbody.innerHTML = '';
            
            if (campaigns.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="text-center">No campaigns found</td></tr>';
                return;
            }
            
            campaigns.forEach(campaign => {
                const row = document.createElement('tr');
                const progress = Math.round((campaign.sent_count / campaign.total_recipients) * 100) || 0;
                
                row.innerHTML = `
                    <td>${campaign.id.slice(0, 8)}...</td>
                    <td>${campaign.name}</td>
                    <td><span class="badge badge-${getStatusColor(campaign.status)}">${campaign.status}</span></td>
                    <td>${campaign.total_recipients}</td>
                    <td>${campaign.sent_count || 0}</td>
                    <td>${campaign.failed_count || 0}</td>
                    <td>
                        <div class="mini-progress">
                            <div class="mini-progress-bar" style="width: ${progress}%"></div>
                        </div>
                        <span class="progress-text">${progress}%</span>
                    </td>
                    <td>${new Date(campaign.created_at).toLocaleDateString()}</td>
                    <td>
                        <button class="btn-icon" onclick="viewCampaign('${campaign.id}')">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn-icon" onclick="deleteCampaign('${campaign.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        async function loadRecentMessages() {
            try {
                const response = await fetch('/api/stats/messages?limit=20');
                const data = await response.json();
                
                if (data.success) {
                    renderMessagesTable(data.data);
                }
            } catch (error) {
                console.error('Failed to load messages:', error);
            }
        }

        function renderMessagesTable(messages) {
            const tbody = document.getElementById('messagesTableBody');
            tbody.innerHTML = '';
            
            if (messages.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center">No messages found</td></tr>';
                return;
            }
            
            messages.forEach(msg => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${new Date(msg.created_at).toLocaleTimeString()}</td>
                    <td>${msg.phone_number}</td>
                    <td class="message-preview">${msg.message_text.substring(0, 50)}...</td>
                    <td><span class="badge badge-${msg.status === 'sent' ? 'success' : 'danger'}">${msg.status}</span></td>
                    <td><span class="badge badge-${msg.direction === 'outgoing' ? 'info' : 'secondary'}">${msg.direction}</span></td>
                `;
                tbody.appendChild(row);
            });
        }

        function getStatusColor(status) {
            const colors = {
                running: 'primary',
                completed: 'success',
                paused: 'warning',
                stopped: 'secondary',
                failed: 'danger'
            };
            return colors[status] || 'secondary';
        }

        async function forceLogout() {
            if (!confirm('Force logout WhatsApp? This will disconnect all sessions.')) return;
            
            try {
                const response = await fetch('/api/whatsapp/logout', { method: 'POST' });
                const data = await response.json();
                
                if (data.success) {
                    showToast('WhatsApp logged out successfully', 'success');
                    setTimeout(() => location.reload(), 2000);
                }
            } catch (error) {
                showToast('Logout failed', 'error');
            }
        }

        function filterCampaigns(status) {
            // Filter logic
            loadAllCampaigns();
        }

        function viewCampaign(id) {
            window.location.href = `/dashboard?campaign=${id}`;
        }

        function deleteCampaign(id) {
            if (!confirm('Delete this campaign?')) return;
            // Delete logic
        }
    </script>
</body>
</html>
